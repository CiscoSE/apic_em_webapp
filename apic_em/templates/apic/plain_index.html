<!DOCTYPE html>
<html><head lang="en">



    <meta charset="UTF-8"><title></title></head><body style="color: rgb(0, 0, 0);" alink="#ee0000" link="#0000ee" vlink="#551a8b">
<h1>Step 1 - Get a ticket from the APIC</h1>
In order to limit the number of times the APIC-EM appliance hits your
backend AAA server, you only need to authenticate once to get a
"ticket".&nbsp; This ticket will be included in the header of
subsequent API calls.&nbsp; An example of the ticket request is below
followed by the actual ticket we received to render this page.<br>
<br>
<div style="margin-left: 40px; background-color: rgb(255, 255, 204);">def get_token(url):<br><span style="color: rgb(51, 51, 255);">&nbsp;&nbsp;&nbsp;
#This function receives the "url" which points at the APIC-EM
server.&nbsp; We are using the sandbox available at Cisco.<br>&nbsp;&nbsp;&nbsp; #"https://sandboxapic.cisco.com/api/v1"<br>&nbsp;&nbsp;&nbsp; #Next we define API call</span><br>&nbsp;&nbsp;&nbsp; api_call = "/ticket"<br><br>&nbsp;<span style="color: rgb(51, 51, 255);">&nbsp;&nbsp; # Payload contains authentication information</span><br style="color: rgb(51, 51, 255);">&nbsp;&nbsp;&nbsp; payload = {"username": "devnetuser", "password": "Cisco123!"}<br><br>&nbsp;<span style="color: rgb(51, 51, 255);">&nbsp;&nbsp; # Header information</span><br style="color: rgb(51, 51, 255);">&nbsp;&nbsp;&nbsp; headers = {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "content-type": "application/json"<br>&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;<span style="color: rgb(51, 51, 255);">&nbsp;&nbsp; #combine url and API call</span><br style="color: rgb(51, 51, 255);">&nbsp;&nbsp;&nbsp; url += api_call<br><br>&nbsp;&nbsp;&nbsp; ticket = requests.post(url, data=json.dumps(payload), headers=headers, verify=False)<br>&nbsp;&nbsp;&nbsp; return ticket<br></div>
<br>
<div style="margin-left: 40px;">We received the ticket: {{ ticket }}<br></div>
<h1>Step 2 - Query a list of devices<br></h1>
We will now take the authentication token and ask the APIC-EM for a
list of devices.&nbsp; Exploring the API, we find that there are more
than two dozen different items we could use as filters including;
location, type, serial number, location and role.&nbsp; Let's use the
"role" to look for devices tagged as "Access".<br>
<br>
<div style="margin-left: 40px; background-color: rgb(255, 255, 204);">def get_device_id(token, url):<br><span style="color: rgb(51, 51, 255);">&nbsp;&nbsp;&nbsp; #This function receives the token from the previous function and the URL of the APIC-EM server</span><br style="color: rgb(51, 51, 255);"><span style="color: rgb(51, 51, 255);">&nbsp;&nbsp;&nbsp; #Again we define the API call</span><br style="color: rgb(51, 51, 255);">&nbsp;&nbsp;&nbsp; api_call = "/network-device"<br><br>&nbsp;<span style="color: rgb(51, 51, 255);">&nbsp;&nbsp; #The header info is where we use the authentication token</span><br style="color: rgb(51, 51, 255);">&nbsp;&nbsp;&nbsp; headers = {"X-AUTH-TOKEN": token}<br><br>&nbsp;&nbsp;&nbsp; url += api_call<br><br>&nbsp;&nbsp;&nbsp; response = requests.get(url, headers=headers, verify=False).json()<br><br>&nbsp;<span style="color: rgb(51, 51, 255);">&nbsp;&nbsp;
#We iterate through response looking for the ACCESS role.&nbsp; We
could take some action on the entire list of devices with <br>&nbsp;&nbsp;&nbsp;
#this role.&nbsp; However, to keep things simple, we are only going to
return the ID of the first "ACCESS" device we find.</span><br style="color: rgb(51, 51, 255);"><span style="color: rgb(51, 51, 255);">&nbsp;</span>&nbsp;&nbsp; for item in response['response']:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if item['role'] == 'ACCESS':<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return item['id']<br></div>
<br>
<div style="margin-left: 40px;">The device we selected has the ID: {{ deviceID }}<br></div>
<h1>Step 3 - Take an action on the selected device(s)<br></h1>
With a list of devices that meet our criteria, now we can take a series
of actions on those devices.&nbsp; We could log into the devices
directly using SNMP or NETCONF, but let's leverage the APIC-EM
network-device-config to recover the running config.<br>
<br>
<div style="margin-left: 40px; background-color: rgb(255, 255, 204);">def get_config(token, url, id):<br>
<span style="color: rgb(51, 51, 255);">&nbsp;&nbsp;&nbsp; #We accept the token, APIC-EM URL and the ID of the device we previously selected</span><br style="color: rgb(51, 51, 255);">
<span style="color: rgb(51, 51, 255);">&nbsp;&nbsp;&nbsp; #We define API call.&nbsp; The API includes the ID to only request the configuration of the single device.</span><br style="color: rgb(51, 51, 255);">
&nbsp;&nbsp;&nbsp; api_call = '/network-device/' + id + '/config'<br>
<br>
&nbsp;<span style="color: rgb(51, 51, 255);">&nbsp;&nbsp; #The header info is where we use the authentication token</span><br style="color: rgb(51, 51, 255);">
<span style="color: rgb(51, 51, 255);">&nbsp;</span>&nbsp;&nbsp; headers = {'X-AUTH-TOKEN': token}<br>
<br>
&nbsp;&nbsp;&nbsp; url += api_call<br>
<br>
&nbsp;&nbsp;&nbsp; response = requests.get(url, headers=headers, verify=False).json()<br>
&nbsp;&nbsp;&nbsp; return response<br></div>
<br>
<br>
<div style="margin-left: 40px;">
{% if output %}
    {% for line in output %}
        <br>{{ line }}
    {% endfor %}
{% else %}
    <p>No output is available.</p>
{% endif %}</div>
</body></html>